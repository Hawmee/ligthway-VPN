version: "3.8"

services:
  # --- WireGuard VPN Server ---
  wireguard:
    image: ghcr.io/linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    network_mode: "host"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Africa/Nairobi
      - SERVERURL={ip_addr}
      - SERVERPORT=51820
      - PEERS=client1
      - PEERSDNS=off
      - INTERNAL_SUBNET=192.0.0.0
      - ALLOWEDIPS=0.0.0.0/0
    volumes:
      - ./wireguard-config:/config
      - /lib/modules:/lib/modules:ro
    restart: unless-stopped

  # --- Backend Flask ---
  backend:
    build: ./backend
    container_name: vpn-backend
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
    volumes:
      - ./backend:/app
      - ./wireguard-config:/wireguard-config
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "5000:5000"
    depends_on:
      - wireguard
    restart: unless-stopped

  # --- Frontend React/Vite ---
  frontend:
    build: ./frontend
    container_name: vpn-frontend
   # command: bun run dev -- --host
    volumes:
      - ./frontend:/app
      - /app/node_modules 
    ports:
      - "5173:5173"
    depends_on:
      - backend
#    environment:
#      - CHOKIDAR_USEPOLLING=true
    restart: unless-stopped

  wgexporter:
    image: mindflavor/prometheus-wireguard-exporter:latest
    container_name: wgexporter
    network_mode: host
    privileged: true
    restart: unless-stopped
    volumes:
      - /etc/wireguard:/etc/wireguard:ro
      - /proc:/host/proc:ro
    command: -a true -i wg0

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"

#   grafana:
#     image: grafana/grafana:latest
#     container_name: grafana
#     restart: unless-stopped
#     ports:
#       - "3000:3000"
#     environment:
#       - GF_SECURITY_ADMIN_PASSWORD=admin
#     volumes:
#       - grafana-data:/var/lib/grafana
#     depends_on:
#       - prometheus

# volumes:
#   grafana-data:
